<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morse Code Learner</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #f0f0f0; /* Light text */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .app-container {
            background-color: #2c2c2c; /* Slightly lighter dark shade for the container */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px; /* Max width for larger screens */
        }
        .main-title {
            color: #4a90e2; /* A bright blue for the title */
        }
        .input-output-box {
            background-color: #3a3a3a; /* Darker input areas */
            color: #f0f0f0;
            border: 1px solid #555; /* Subtle border */
            border-radius: 4px;
            min-height: 100px;
            padding: 10px;
            white-space: pre-wrap; /* Ensures spaces and newlines are preserved */
            word-wrap: break-word; /* Prevents overflow */
        }
        .controls button, .settings button {
            background-color: #4a90e2; /* Blue buttons */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .controls button:hover, .settings button:hover {
            background-color: #357abd; /* Darker blue on hover */
        }
        .section-title {
            color: #4a90e2; /* Blue for section titles */
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .reference-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .reference-table th, .reference-table td {
            border: 1px solid #555;
            padding: 8px;
            text-align: center;
        }
        .reference-table th {
            background-color: #3a3a3a; /* Header background for table */
        }
        .hidden {
            display: none;
        }
        .active-tab-button {
            background-color: #4A90E2 !important; /* A distinct blue, adjust as needed */
            color: white !important;
            font-weight: 600; /* Tailwind semibold */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .tab-content {
            width: 100%; /* Ensure it spans the full width available */
            /* e.g., padding-top: 1rem; */
        }

        /* Tapper CSS */
        .tapper {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #4a5568; /* Tailwind gray-600 */
            border: 4px solid #2d3748; /* Tailwind gray-700 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #e2e8f0; /* Tailwind gray-300 */
            cursor: pointer;
            user-select: none;
            transition: all 0.1s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            flex-shrink: 0; /* Added from original context if tapper was in flex */
        }
        .tapper:active, .tapper.active {
            background-color: #f6e05e; /* Tailwind yellow-300 */
            color: #1a202c; /* Tailwind gray-900 */
            transform: scale(0.95);
            box-shadow: 0 0 20px #f6e05e, 0 0 30px #f6e05e;
        }
        #spaceButton {
            /* Using Tailwind in HTML for most styling */
            /* Example: width: 70px; height: 70px; border-radius: 50%; */
        }
        .table-highlight {
            background-color: #f6e05e; /* Tailwind yellow-300 or a similar vibrant color */
            color: #1a202c; /* Tailwind gray-900 or a dark color for contrast */
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="flex justify-center mb-4 space-x-2">
        <button id="learn-practice-nav-btn" data-tab="learn-practice-tab" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 active-tab-button">Learn & Practice</button>
        <button id="book-cipher-nav-btn" data-tab="book-cipher-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Book Cipher</button>
        <button id="morse-pals-nav-btn" data-tab="morse-pals-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Morse Pals</button>
        <button id="global-beacon-nav-btn" data-tab="global-beacon-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Global Beacon</button>
        <button id="settings-nav-btn" data-tab="settings-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Settings</button>
    </nav>
    <h1 class="text-4xl font-bold mb-8 text-center main-title">Morse Code Learner</h1>
    <div id="tab-content-wrapper">
        <div id="learn-practice-tab" class="tab-content">
            <div class="app-container">

                <!-- Tapper Area for Learn & Practice Tab -->
                <div id="learnPracticeTapperArea" class="text-center my-4">
                    <!-- The shared visual tapper will be inserted here by JavaScript -->
                     <h3 class="text-xl font-semibold mb-2">Practice Tapping Morse</h3>
                </div>

                <!-- Interactive Practice Game Area -->
                <div id="interactivePracticeGame" class="mt-4">
                    <p id="practiceText" class="text-3xl font-bold text-yellow-400 min-h-[40px] text-center"></p>
                    <p id="tapperDecodedOutput" class="text-2xl min-h-[30px] break-all text-center bg-gray-700 p-2 rounded mt-2"></p>
                    <p id="practiceMessage" class="text-lg text-center min-h-[24px] mt-2"></p>
                    <button id="newChallengeButton" class="mt-2 w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">New Challenge</button>
                    <button id="play-tapped-morse-btn" class="mt-2 w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Play My Tapped Morse</button>
                    <button id="clearTapperInputButton" class="mt-2 w-full bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Clear My Tapping</button>
                </div>
                <!-- End Interactive Practice Game Area -->

                <div class="controls mb-6 text-center">
            <button id="play-morse-btn" class="mr-2">Play Morse Code</button>
            <button id="stop-morse-btn" class="mr-2">Stop Sound</button>
            <button id="copy-text-btn" class="mr-2">Copy Text</button>
            <button id="copy-morse-btn">Copy Morse</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="text-input" class="block text-sm font-medium mb-1">Enter Text:</label>
                <textarea id="text-input" class="input-output-box w-full" placeholder="Type text here..."></textarea>
            </div>
            <div>
                <label for="morse-output" class="block text-sm font-medium mb-1">Morse Code Output:</label>
                <textarea id="morse-output" class="input-output-box w-full" placeholder="Or type Morse here (e.g. .... . .-.. .-.. ---)" readonly></textarea>
            </div>
        </div>

        <div class="settings mb-6">
            <h2 class="section-title text-2xl font-semibold mb-3 text-center">Morse Playback Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                <div>
                    <label for="wpm-slider" class="block text-sm font-medium">Text Playback Speed (WPM): <span id="wpm-value">20</span></label>
                    <input type="range" id="wpm-slider" min="5" max="40" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="farnsworth-slider" class="block text-sm font-medium">Text Playback Farnsworth WPM: <span id="farnsworth-value">20</span></label>
                    <input type="range" id="farnsworth-slider" min="5" max="40" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="freq-slider" class="block text-sm font-medium">Playback Tone Frequency (Hz): <span id="freq-value">600</span></label>
                    <input type="range" id="freq-slider" min="300" max="1000" value="600" step="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
             <div class="mt-4 flex justify-center">
                <button id="toggle-theme-btn">Toggle Dark/Light Mode</button>
            </div>
        </div>

        <div class="morse-reference">
            <h2 class="section-title text-2xl font-semibold mb-3 text-center">Morse Code Reference</h2>
            <div class="overflow-x-auto">
                <table class="reference-table mx-auto">
                    <thead>
                        <tr>
                            <th>Character</th>
                            <th>Morse</th>
                            <th>Character</th>
                            <th>Morse</th>
                            <th>Character</th>
                            <th>Morse</th>
                            <th>Character</th>
                            <th>Morse</th>
                        </tr>
                    </thead>
                    <tbody id="morse-reference-body">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>
        <div id="book-cipher-tab" class="tab-content hidden">
            <div class="app-container mx-auto p-6 bg-gray-800 shadow-xl rounded-lg">
                
                <div id="bookCipherTapperArea" class="text-center my-4">
                    <!-- The shared visual tapper will be inserted here by JavaScript -->
                </div>

                <!-- Book Selection Dropdown -->
                <div class="mb-4">
                    <label for="book-selection" class="block mb-2 text-sm font-medium text-gray-300">Select Book:</label>
                    <select id="book-selection" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option selected>Choose a book</option>
                        <option value="wildwood">The Call of the Wildwood</option>
                        <option value="morse_mysteries">Morse Mysteries Vol. 1</option>
                        <option value="code_star">Journey to the Code Star</option>
                    </select>
                </div>

                <!-- Obscured/Target Text Display -->
                <div class="mb-4">
                    <label for="target-text-display" class="block mb-2 text-sm font-medium text-gray-300">Target Text:</label>
                    <div id="target-text-display" class="p-3 min-h-[100px] bg-gray-700 border border-gray-600 rounded-md text-gray-300 whitespace-pre-wrap word-wrap-break-word">**** *** ****</div>
                </div>

                <!-- Unlocked Text Display -->
                <div class="mb-4">
                    <label for="unlocked-text-display" class="block mb-2 text-sm font-medium text-gray-300">Your Unlocked Text:</label>
                    <div id="unlocked-text-display" class="p-3 min-h-[100px] bg-gray-700 border border-gray-600 rounded-md text-gray-300 whitespace-pre-wrap word-wrap-break-word">-</div>
                </div>

                <!-- Current Decoded Character Display -->
                <div class="mb-4 text-center">
                    <label for="current-decoded-char" class="block mb-2 text-sm font-medium text-gray-300">Current Character:</label>
                    <div id="current-decoded-char" class="p-2 bg-gray-700 rounded-md text-xl font-mono text-center min-w-[50px] inline-block text-gray-300">-</div>
                </div>
                
                <!-- Morse Input/Output Area -->
                <div class="mb-6">
                    <label for="book-cipher-morse-io" class="block text-sm font-medium text-gray-300 mb-1">Morse Input/Output:</label>
                    <textarea id="book-cipher-morse-io" class="input-output-box w-full" placeholder="Morse input/output for book cipher..."></textarea>
                </div>

                <!-- Start Button -->
                <div class="text-center">
                    <button id="start-book-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">Start Selected Book</button>
                </div>
            </div>
        </div>
        <div id="morse-pals-tab" class="tab-content hidden">
            <!-- Placeholder for Morse Pals content -->
            <p class="text-center text-xl p-8">Morse Pals Content Coming Soon!</p>
        </div>
        <div id="global-beacon-tab" class="tab-content hidden">
            <!-- Placeholder for Global Beacon content -->
            <p class="text-center text-xl p-8">Global Beacon Content Coming Soon!</p>
        </div>
        <div id="settings-tab" class="tab-content hidden">
            <div class="app-container">
                <h2 class="section-title text-2xl font-semibold mb-3 text-center">Tapper Speed Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center justify-items-center p-4">
                    <div class="w-full">
                        <label for="unit-time-input" class="block text-sm font-medium mb-1">Morse Unit Time (ms):</label>
                        <input type="number" id="unit-time-input" value="150" min="50" max="500" step="10" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-white">
                    </div>
                    <div class="mt-4 md:mt-0 w-full text-center md:text-left">
                        <p class="text-sm font-medium text-gray-300">Current effective value: <span id="current-unit-time-display" class="font-bold text-white">150</span> ms</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hiddenTapperStorage" style="display: none;"></div>
    <div id="sharedVisualTapperWrapper" style="display: none;">
        <div class="tapper-section-container text-center my-4">
            <div class="tapper-area inline-block mr-2">
                <div class="tapper-container">
                    <div id="tapper" class="tapper shadow-lg mx-auto">Tap!</div>
                </div>
            </div>
            <button id="spaceButton" title="End Letter" class="align-middle text-sm bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-full h-14 w-14 flex items-center justify-center">End<br>Ltr</button>
            <div class="output-area mt-2">
                <h3 class="text-lg font-semibold mb-1">Your Morse:</h3>
                <p id="tapperMorseOutput" class="text-xl font-mono min-h-[25px] break-all bg-gray-700 p-2 rounded"></p>
            </div>
        </div>
    </div>
    
    <script>
        // Morse code dictionary
        const morseCode = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 'G': '--.', 'H': '....',
            'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---', 'P': '.--.',
            'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..',
            '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...',
            '8': '---..', '9': '----.', '0': '-----',
            '.': '.-.-.-', ',': '--..--', '?': '..--..', "'": '.----.', '!': '-.-.--', '/': '-..-.',
            '(': '-.--.', ')': '-.--.-', '&': '.-...', ':': '---...', ';': '-.-.-.', '=': '-...-',
            '+': '.-.-.', '-': '-....-', '_': '..--.-', '"': '.-..-.', '$': '...-..-', '@': '.--.-.-',
            ' ': '/' // Represent space between words with a slash or longer pause
        };

        const reversedMorseCode = {};
        for (const key in morseCode) {
            reversedMorseCode[morseCode[key]] = key;
        }

        // AudioContext for playing Morse code sound
        let audioContext;
        let oscillator;
        let gainNode;
        let isPlaying = false;
        let stopMorseCode = false; // Flag to stop ongoing Morse playback

        // DOM Elements
        const textInput = document.getElementById('text-input');
        const morseOutput = document.getElementById('morse-output');
        const playMorseBtn = document.getElementById('play-morse-btn');
        const stopMorseBtn = document.getElementById('stop-morse-btn');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const copyMorseBtn = document.getElementById('copy-morse-btn');
        const wpmSlider = document.getElementById('wpm-slider');
        const wpmValue = document.getElementById('wpm-value');
        const farnsworthSlider = document.getElementById('farnsworth-slider');
        const farnsworthValue = document.getElementById('farnsworth-value');
        const freqSlider = document.getElementById('freq-slider');
        const freqValue = document.getElementById('freq-value');
        const morseReferenceBody = document.getElementById('morse-reference-body');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');


        // Initialize AudioContext
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
            }
        }

        // Settings
        let wpm = parseInt(wpmSlider.value);
        let farnsworthWpm = parseInt(farnsworthSlider.value); // Farnsworth WPM
        let frequency = parseInt(freqSlider.value);

        // Timing (PARIS standard)
        // Dot is 1 unit
        // Dash is 3 units
        // Intra-character space is 1 unit
        // Inter-character space is 3 units
        // Word space is 7 units

        // WPM calculation: A standard word "PARIS" has 50 units.
        // If WPM is X, then X words take 60 seconds.
        // X * 50 units = 60 seconds
        // 1 unit = 60 / (X * 50) = 1.2 / X seconds
        let dotDuration = 1.2 / wpm; // seconds

        function updateDurations() {
            dotDuration = 1.2 / wpm;
            if (farnsworthWpm < wpm && farnsworthWpm > 0) {
                // Adjust inter-character and word spaces for Farnsworth timing
                // Character speed remains at 'wpm', but spacing is as if overall WPM is 'farnsworthWpm'
                // This means the 'unit' for spacing is based on farnsworthWpm
                // However, dot/dash/intra-character space are based on 'wpm'
                // This is a common interpretation. Some systems might vary.
            }
             // Ensure Farnsworth is not faster than character speed
            if (farnsworthSlider.value > wpmSlider.value) {
                farnsworthSlider.value = wpmSlider.value;
                farnsworthValue.textContent = wpmSlider.value;
                farnsworthWpm = wpm;
            }
        }
        updateDurations(); // Initial calculation

        // --- Event Listeners ---
        textInput.addEventListener('input', () => {
            const text = textInput.value.toUpperCase();
            morseOutput.value = textToMorse(text);
        });

        morseOutput.addEventListener('input', () => {
            // Basic attempt to allow Morse input - needs refinement for robustness
            const morse = morseOutput.value.trim();
            textInput.value = morseToText(morse);
        });

        playMorseBtn.addEventListener('click', async () => {
            if (isPlaying) return;
            initAudio(); // Ensure AudioContext is ready (especially on user gesture)
            const morse = morseOutput.value;
            if (morse) {
                await playMorseSequence(morse);
            }
        });

        stopMorseBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopMorseCode = true; // Set flag to stop the sequence
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect(); // Clean up
                    oscillator = null;
                }
                if (gainNode) { // Ensure gainNode is controlled
                    gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                }
                isPlaying = false;
                playMorseBtn.disabled = false;
                console.log("Morse playback stopped by user.");
            }
        });


        copyTextBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(textInput.value)
                .then(() => alert('Text copied to clipboard!'))
                .catch(err => console.error('Error copying text: ', err));
        });

        copyMorseBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(morseOutput.value)
                .then(() => alert('Morse code copied to clipboard!'))
                .catch(err => console.error('Error copying Morse code: ', err));
        });

        wpmSlider.addEventListener('input', (e) => {
            wpm = parseInt(e.target.value);
            wpmValue.textContent = wpm;
            if (farnsworthWpm > wpm) { // Ensure Farnsworth isn't faster
                farnsworthWpm = wpm;
                farnsworthSlider.value = wpm;
                farnsworthValue.textContent = wpm;
            }
            updateDurations();
        });

        farnsworthSlider.addEventListener('input', (e) => {
            farnsworthWpm = parseInt(e.target.value);
            farnsworthValue.textContent = farnsworthWpm;
            if (farnsworthWpm > wpm) { // User tries to set Farnsworth higher than WPM
                wpm = farnsworthWpm; // Adjust WPM to match Farnsworth
                wpmSlider.value = farnsworthWpm;
                wpmValue.textContent = farnsworthWpm;
            }
            updateDurations();
        });


        freqSlider.addEventListener('input', (e) => {
            frequency = parseInt(e.target.value);
            freqValue.textContent = frequency;
        });

        toggleThemeBtn.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            document.querySelector('.app-container').classList.toggle('light-theme-container');

            // Persist theme preference
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.setItem('theme', 'dark');
            }
        });


        // --- Core Functions ---

// --- Tab Navigation ---
const navTabButtons = document.querySelectorAll('nav button[data-tab]');
const tabContentDivs = document.querySelectorAll('.tab-content');
const sharedVisualTapperWrapper = document.getElementById('sharedVisualTapperWrapper');
const hiddenTapperStorage = document.getElementById('hiddenTapperStorage');

function attachTapperToArea(targetAreaId) {
    const targetElement = document.getElementById(targetAreaId);
    if (sharedVisualTapperWrapper && targetElement) {
        targetElement.appendChild(sharedVisualTapperWrapper);
        sharedVisualTapperWrapper.style.display = 'block'; // Or 'flex' if its internal layout needs it
        console.log(`Tapper attached to ${targetAreaId}`);
    } else {
        console.error(`Failed to attach tapper: sharedVisualTapperWrapper (${sharedVisualTapperWrapper}) or targetElement (${targetElement} for ID ${targetAreaId}) not found.`);
    }
}

function detachSharedTapper() {
    // Call resetVisualTapperState if it's available
    if (typeof resetVisualTapperState === 'function') {
        resetVisualTapperState();
    } else {
        console.warn("detachSharedTapper: resetVisualTapperState function not found. Tapper state may not be fully reset.");
    }

    if (sharedVisualTapperWrapper && hiddenTapperStorage) {
        // Ensure the tapper is moved to hidden storage if it's not already there.
        if (sharedVisualTapperWrapper.parentNode !== hiddenTapperStorage) {
            hiddenTapperStorage.appendChild(sharedVisualTapperWrapper);
        }
        // Always hide it when detaching.
        sharedVisualTapperWrapper.style.display = 'none';
        console.log("Tapper detached and hidden. State reset attempted.");
    } else {
         console.error(`Failed to detach tapper: sharedVisualTapperWrapper (${sharedVisualTapperWrapper}) or hiddenTapperStorage (${hiddenTapperStorage}) not found. State reset was attempted if function was available.`);
    }
}


function showTab(tabIdToShow) {
    // Detach tapper from any previous tab BEFORE hiding all tabs
    detachSharedTapper();

    tabContentDivs.forEach(div => {
        div.classList.add('hidden');
    });

    navTabButtons.forEach(button => {
        button.classList.remove('active-tab-button');
        button.classList.add('bg-gray-700', 'text-gray-300');
        button.classList.remove('bg-blue-600', 'text-white');
    });

    const selectedTabContent = document.getElementById(tabIdToShow);
    if (selectedTabContent) {
        selectedTabContent.classList.remove('hidden');
    }

    const selectedNavButton = document.querySelector(`nav button[data-tab='${tabIdToShow}']`);
    if (selectedNavButton) {
        selectedNavButton.classList.add('active-tab-button');
        selectedNavButton.classList.remove('bg-gray-700', 'text-gray-300');
        selectedNavButton.classList.add('bg-blue-600', 'text-white');
    }

    // Attach tapper to the new tab if it's the book cipher tab or learn & practice tab
    if (tabIdToShow === 'book-cipher-tab') {
        attachTapperToArea('bookCipherTapperArea');
    } else if (tabIdToShow === 'learn-practice-tab') {
        attachTapperToArea('learnPracticeTapperArea');
    }
    // No 'else' here, so if it's another tab, tapper remains detached (which is correct)
}

navTabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        showTab(tabId);
    });
});

document.addEventListener('DOMContentLoaded', () => {
    // Set the initial active tab correctly.
    // The learn-practice-nav-btn might already have active-tab-button from HTML.
    // This call ensures consistent state management via JS.
    showTab('learn-practice-tab'); // Initial tab
    // Explicit detach on DOMContentLoaded after initial showTab is good practice,
    // though current showTab logic handles it.
    // If learn-practice-tab is not supposed to have tapper, this ensures it's gone.
    // If learn-practice-tab *was* supposed to have it, showTab would call attach.
    // Given showTab now detaches first, this specific call here might be redundant
    // unless the very first tab shown *shouldn't* have the tapper.
    // Let's assume 'learn-practice-tab' does not use the tapper initially.
    // The `showTab` function already calls `detachSharedTapper`, so this is not strictly needed here.
    // detachSharedTapper(); 
});
// --- End Tab Navigation ---

        function textToMorse(text) {
            return text.split('').map(char => {
                if (morseCode[char]) {
                    return morseCode[char];
                } else if (char === ' ') {
                    return '/'; // Word separator
                }
                return ''; // Or some indicator for unknown characters
            }).join(' '); // Space between Morse codes of letters
        }

        function morseToText(morse) {
            return morse.split(' ').map(code => {
                if (code === '/') return ' '; // Word separator
                return reversedMorseCode[code] || ''; // Or indicator for unknown code
            }).join('');
        }

       async function playTone(duration, isLastSignal = false, toneFrequency) {
            if (stopMorseCode || !audioContext) return; // Check stop flag and audio context

            return new Promise(resolve => {
                if (!audioContext || audioContext.state === 'suspended') {
                    console.warn("AudioContext not active. Cannot play tone.");
                    resolve();
                    return;
                }

                oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                // Use the provided toneFrequency, or default to global frequency if undefined
                const currentFrequency = typeof toneFrequency === 'number' ? toneFrequency : frequency;
                oscillator.frequency.setValueAtTime(currentFrequency, audioContext.currentTime);

                // Ramp up volume smoothly
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01); // Quick ramp up

                oscillator.connect(gainNode);
                oscillator.start(audioContext.currentTime);

                // Schedule stop and ramp down
                oscillator.stop(audioContext.currentTime + duration);
                // Ramp down volume smoothly before stopping
                gainNode.gain.setValueAtTime(1, audioContext.currentTime + duration - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);


                oscillator.onended = () => {
                    if (oscillator && oscillator.connected) { // Check if it's the current oscillator
                         oscillator.disconnect();
                    }
                    resolve();
                };
            });
        }


        async function playMorseSequence(morse, customDotDur, customFreq) {
            if (isPlaying) return;
            isPlaying = true;
            stopMorseCode = false; // Reset stop flag
            playMorseBtn.disabled = true; // Consider disabling the other play button too if custom playback is active

            const currentPlaybackFrequency = typeof customFreq === 'number' ? customFreq : frequency;

            let effectiveDotDuration;
            let effectiveInterCharSpace;
            let effectiveWordSpace;
            let effectiveIntraCharSilence;

            if (typeof customDotDur === 'number') {
                effectiveDotDuration = customDotDur;
                effectiveIntraCharSilence = effectiveDotDuration; // 1 unit silence after each signal
                effectiveInterCharSpace = 3 * effectiveDotDuration; // 3 units for inter-character
                effectiveWordSpace = 7 * effectiveDotDuration;    // 7 units for word space
            } else {
                // Use existing WPM/Farnsworth logic
                effectiveDotDuration = dotDuration; // Global dotDuration based on WPM
                effectiveIntraCharSilence = dotDuration; // Base silence is 1 WPM-based unit

                let spaceUnit = 1.2 / (farnsworthWpm > 0 && farnsworthWpm < wpm ? farnsworthWpm : wpm);
                effectiveInterCharSpace = 3 * spaceUnit;
                effectiveWordSpace = 7 * spaceUnit;
            }

            const signals = morse.split('');
            for (let i = 0; i < signals.length; i++) {
                if (stopMorseCode) {
                    console.log("Stopping Morse sequence playback.");
                    break;
                }

                const signal = signals[i];
                let signalDuration = 0;
                // Default silence after a signal is the intra-character silence unit
                let silenceDurationAfterSignal = effectiveIntraCharSilence;

                if (signal === '.') {
                    signalDuration = effectiveDotDuration;
                } else if (signal === '-') {
                    signalDuration = 3 * effectiveDotDuration;
                } else if (signal === ' ') { // Space between letters in the same word
                    // This signal itself is silence. The silence *after* this "signal" is what we calculate.
                    // The total silence for an inter-character space is `effectiveInterCharSpace`.
                    // Since `silenceDurationAfterSignal` (1 unit) is already added by default,
                    // we adjust the duration of this "space signal" to make up the difference.
                    signalDuration = 0; // No tone for space
                    // Total silence needed is effectiveInterCharSpace.
                    // The loop adds effectiveIntraCharSilence by default.
                    // So, the "duration" of this space signal should be effectiveInterCharSpace - effectiveIntraCharSilence
                    silenceDurationAfterSignal = effectiveInterCharSpace - effectiveIntraCharSilence;
                     if (silenceDurationAfterSignal < 0) silenceDurationAfterSignal = 0; // Should not happen with correct logic
                } else if (signal === '/') { // Space between words
                    signalDuration = 0; // No tone for space
                    // Total silence needed is effectiveWordSpace.
                    silenceDurationAfterSignal = effectiveWordSpace - effectiveIntraCharSilence;
                    if (silenceDurationAfterSignal < 0) silenceDurationAfterSignal = 0;
                }

                if (signalDuration > 0) {
                    await playTone(signalDuration, i === signals.length - 1, currentPlaybackFrequency);
                }

                // After the tone (or if it was a space character that has 0 signal duration), wait for its specific silence duration
                if (silenceDurationAfterSignal > 0 && !stopMorseCode) {
                    await new Promise(resolve => setTimeout(resolve, silenceDurationAfterSignal * 1000));
                }
            }
            isPlaying = false;
            playMorseBtn.disabled = false; // Re-enable the main play button
            // Consider if the custom play button also needs its state managed (e.g., playTappedMorseBtn.disabled = false;)
            if (stopMorseCode) {
                console.log("Morse sequence officially ended due to stop request.");
            }
        }


        // --- UI Initialization ---
        function populateMorseReference() {
    const characters = Object.keys(morseCode);
    let rowContent = '';
    for (let i = 0; i < characters.length; i++) {
        if (i % 4 === 0) { // Start new row
            if (i > 0) rowContent += '</tr>';
            rowContent += '<tr>';
        }
        const char = characters[i];
        const displayChar = char === ' ' ? 'Space' : char;

        let idChar = char; // Default to using the char itself for ID
        // Mapping for characters that are problematic in IDs or need a specific name
        if (char === '.') idChar = 'Period';
        else if (char === ',') idChar = 'Comma';
        else if (char === '?') idChar = 'QuestionMark';
        else if (char === "'") idChar = 'Apostrophe';
        else if (char === '!') idChar = 'ExclamationMark';
        else if (char === '/') idChar = 'Slash';
        else if (char === '(') idChar = 'ParenthesisOpen';
        else if (char === ')') idChar = 'ParenthesisClose';
        else if (char === '&') idChar = 'Ampersand';
        else if (char === ':') idChar = 'Colon';
        else if (char === ';') idChar = 'Semicolon';
        else if (char === '=') idChar = 'Equals';
        else if (char === '+') idChar = 'Plus';
        else if (char === '-') idChar = 'Hyphen';
        else if (char === '_') idChar = 'Underscore';
        else if (char === '"') idChar = 'Quote';
        else if (char === '$') idChar = 'Dollar';
        else if (char === '@') idChar = 'AtSign';
        else if (char === ' ') idChar = 'Space';
        // Alphanumeric characters (A-Z, 0-9) will use their own value for idChar.

        rowContent += `<td id="ref-char-${idChar}">${displayChar}</td><td id="ref-morse-${idChar}">${morseCode[char]}</td>`;

        if (i === characters.length - 1) { // Ensure last row is closed correctly
            let cellsInLastRow = (i % 4) + 1; // Number of items processed for the current row
            if (cellsInLastRow < 4) {
                for (let j = cellsInLastRow; j < 4; j++) {
                    rowContent += '<td></td><td></td>'; // Add empty pairs for missing items
                }
            }
            rowContent += '</tr>'; // Close the last row
        }
    }
    morseReferenceBody.innerHTML = rowContent;
}


        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                document.querySelector('.app-container').classList.add('light-theme-container');
            } else {
                // Dark theme is default, so no need to remove classes if they aren't there
                // but if they are (e.g. from a previous session), ensure they are removed.
                document.body.classList.remove('light-theme');
                document.querySelector('.app-container').classList.remove('light-theme-container');
            }
        }


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateMorseReference();
            applySavedTheme(); // Apply theme on load
            updateDurations(); // Initialize durations based on default slider values

            // Set initial values for sliders display
            wpmValue.textContent = wpmSlider.value;
            farnsworthValue.textContent = farnsworthSlider.value;
            freqValue.textContent = freqSlider.value;

            // Event listener for "Play My Tapped Morse" button
            const playTappedMorseBtn = document.getElementById('play-tapped-morse-btn');
            const tapperDecodedOutputEl = document.getElementById('tapperDecodedOutput');

            if (playTappedMorseBtn && tapperDecodedOutputEl) {
                playTappedMorseBtn.addEventListener('click', async () => {
                    if (isPlaying) {
                        console.log("Audio is currently playing. Please wait.");
                        return;
                    }
                    initAudio(); // Ensure AudioContext is ready

                    const textToPlay = tapperDecodedOutputEl.textContent;
                    if (!textToPlay || textToPlay.trim() === '') {
                        console.log("No tapped text to play.");
                        // Optionally, provide user feedback e.g., alert("No tapped text to play.");
                        return;
                    }

                    const morseToPlay = textToMorse(textToPlay.toUpperCase());
                    if (!morseToPlay || morseToPlay.trim() === '') {
                        console.log("Could not convert tapped text to Morse.");
                        // Optionally, provide user feedback
                        return;
                    }

                    // Assuming UNIT_TIME_MS is globally available (e.g., window.UNIT_TIME_MS)
                    // This value would typically come from visualTapper.js or settings.js
                    let currentUnitTimeMs = 150; // Default if not found
                    if (typeof UNIT_TIME_MS !== 'undefined') {
                        currentUnitTimeMs = UNIT_TIME_MS;
                    } else if (typeof window.UNIT_TIME_MS !== 'undefined') {
                        currentUnitTimeMs = window.UNIT_TIME_MS;
                    } else {
                        console.warn("Global UNIT_TIME_MS not found, using default 150ms for playback. This might lead to inconsistent playback speed with tapper settings.");
                    }

                    const customDotDuration = currentUnitTimeMs / 1000.0; // Convert ms to seconds

                    // The global `frequency` variable (updated by #freq-slider) will be used by playMorseSequence directly
                    // Or, if playMorseSequence is modified to take frequency, pass it:
                    // await playMorseSequence(morseToPlay, customDotDuration, frequency);
                    // For now, assuming playMorseSequence will be modified to accept customDotDuration
                    // and will continue to use the global `frequency`.
                    // The subtask asks to call: await playMorseSequence(morseToPlay, customDotDuration, frequency);
                    // This implies playMorseSequence will be updated to use the passed frequency as well.
                    await playMorseSequence(morseToPlay, customDotDuration, frequency);
                });
            } else {
                console.error("Could not find 'play-tapped-morse-btn' or 'tapperDecodedOutput' elements.");
            }
        });

        // VISUAL TAPPER JS HAS BEEN MOVED FROM HERE
    </script>
    <script src="js/learnPracticeGame.js" defer></script>
    <script src="js/visualTapper.js" defer></script>
    <script src="js/settings.js" defer></script> 
    <script src="js/bookCipher.js" defer></script> 
</body>
</html>
