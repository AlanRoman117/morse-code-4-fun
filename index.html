<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morse Code Learner</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #f0f0f0; /* Light text */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .app-container {
            background-color: #2c2c2c; /* Slightly lighter dark shade for the container */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px; /* Max width for larger screens */
        }
        .main-title {
            color: #4a90e2; /* A bright blue for the title */
        }
        .input-output-box {
            background-color: #3a3a3a; /* Darker input areas */
            color: #f0f0f0;
            border: 1px solid #555; /* Subtle border */
            border-radius: 4px;
            min-height: 100px;
            padding: 10px;
            white-space: pre-wrap; /* Ensures spaces and newlines are preserved */
            word-wrap: break-word; /* Prevents overflow */
        }
        .section-title {
            color: #4a90e2; /* Blue for section titles */
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .reference-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .reference-table th, .reference-table td {
            border: 1px solid #555;
            padding: 8px;
            text-align: center;
        }
        .reference-table th {
            background-color: #3a3a3a; /* Header background for table */
        }
        .hidden {
            display: none;
        }
        .active-tab-button {
            font-weight: 600; /* Tailwind semibold */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .tab-content {
            width: 100%; /* Ensure it spans the full width available */
            /* e.g., padding-top: 1rem; */
        }

        /* Tapper CSS */
        .tapper {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #4a5568; /* Tailwind gray-600 */
            border: 4px solid #2d3748; /* Tailwind gray-700 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #e2e8f0; /* Tailwind gray-300 */
            cursor: pointer;
            user-select: none;
            transition: all 0.1s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            flex-shrink: 0; /* Added from original context if tapper was in flex */
        }
        .tapper:active, .tapper.active {
            background-color: #f6e05e; /* Tailwind yellow-300 */
            color: #1a202c; /* Tailwind gray-900 */
            transform: scale(0.95);
            box-shadow: 0 0 20px #f6e05e, 0 0 30px #f6e05e;
        }
        #spaceButton {
            /* Using Tailwind in HTML for most styling */
            /* Example: width: 70px; height: 70px; border-radius: 50%; */
        }
        .table-highlight {
            background-color: #f6e05e; /* Tailwind yellow-300 or a similar vibrant color */
            color: #1a202c; /* Tailwind gray-900 or a dark color for contrast */
            font-weight: bold;
        }

        /* Light Theme Styles */
        body.light-theme {
            background-color: #f3f4f6; /* Tailwind gray-100 */
            color: #1f2937; /* Tailwind gray-800 */
        }
        .app-container.light-theme-container {
            background-color: #ffffff; /* white */
            color: #1f2937; /* Tailwind gray-800 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Lighter shadow */
        }
        .light-theme .input-output-box, /* Applied if body has .light-theme */
        .light-theme-container .input-output-box { /* Applied if .app-container has .light-theme-container */
            background-color: #e5e7eb; /* Tailwind gray-200 */
            color: #1f2937; /* Tailwind gray-800 */
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
        }
        /* Ensure labels are dark in light theme if they have specific color classes */
        .light-theme .text-gray-300,
        .light-theme-container .text-gray-300 {
             color: #374151; /* Tailwind gray-700, or choose appropriate dark shade */
        }
        .light-theme .section-title,
        .light-theme-container .section-title {
            color: #2563eb; /* Tailwind blue-600 for light theme */
        }

        /* Theme-specific styles for Tailwind-styled elements */
        .light-theme #unit-time-input,
        .light-theme-container #unit-time-input {
            background-color: #e5e7eb; /* gray-200 */
            border-color: #d1d5db; /* gray-300 */
            color: #1f2937; /* gray-800 */
        }
        .light-theme #unit-time-input::placeholder,
        .light-theme-container #unit-time-input::placeholder {
            color: #6b7280; /* gray-500 */
        }

        .light-theme #wpm-slider, .light-theme-container #wpm-slider,
        .light-theme #farnsworth-slider, .light-theme-container #farnsworth-slider,
        .light-theme #freq-slider, .light-theme-container #freq-slider {
            background-color: #d1d5db; /* gray-300 for track */
            /* This only styles the track for some browsers if appearance-none is set.
               Full slider styling is complex and browser-specific.
               Tailwind typically handles this with pseudo-elements like ::-webkit-slider-thumb etc.
               which are harder to override cleanly outside of Tailwind's dark: variant.
               For now, this will change the track color.
            */
        }

        .light-theme #book-selection, .light-theme-container #book-selection,
        .light-theme #target-text-display, .light-theme-container #target-text-display,
        .light-theme #unlocked-text-display, .light-theme-container #unlocked-text-display,
        .light-theme #current-decoded-char, .light-theme-container #current-decoded-char,
        .light-theme #tapperDecodedOutput, .light-theme-container #tapperDecodedOutput,
        .light-theme #tapperMorseOutput, .light-theme-container #tapperMorseOutput {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .light-theme #book-selection, .light-theme-container #book-selection,
        .light-theme #target-text-display, .light-theme-container #target-text-display,
        .light-theme #unlocked-text-display, .light-theme-container #unlocked-text-display {
            border-color: #d1d5db; /* gray-300 */
        }
        /* Ensure text-white elements become dark text in light theme */
        .light-theme #book-selection, .light-theme-container #book-selection { /* text-white */
            color: #1f2937; /* gray-800 */
        }

        .light-theme .reference-table th,
        .light-theme-container .reference-table th,
        .light-theme .reference-table td,
        .light-theme-container .reference-table td {
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .light-theme .reference-table th,
        .light-theme-container .reference-table th {
            background-color: #e5e7eb; /* gray-200 */
            /* Text color should be inherited from .app-container.light-theme-container */
        }

        .light-theme .tapper, /* For tapper within .light-theme body */
        .light-theme-container .tapper { /* For tapper within .light-theme-container */
            background-color: #9ca3af; /* Tailwind gray-400 */
            border-color: #6b7280; /* Tailwind gray-500 */
            color: #111827; /* Tailwind gray-900, adjusted for good contrast on gray-400 */
        }
        /* Active state for tapper (.tapper:active or .tapper.active) uses yellow-300 and gray-900,
           which should be fine in light mode as well. No override needed for active state. */

        /* Feedback message styling for themes */
        .light-theme .feedback-message.text-green-500,
        .light-theme-container .feedback-message.text-green-500 {
            color: #16a34a; /* Tailwind green-600 */
        }
        .light-theme .feedback-message.text-red-500,
        .light-theme-container .feedback-message.text-red-500 {
            color: #dc2626; /* Tailwind red-600 */
        }
        .light-theme .feedback-message.text-yellow-500, /* For book cipher messages */
        .light-theme-container .feedback-message.text-yellow-500 {
            color: #d97706; /* Tailwind amber-600 for better contrast on light bg */
        }

    /* Styling for selected friend in Morse Pals list */
    .selected-friend {
        background-color: #4A5568; /* Tailwind gray-600, a bit darker than hover to show selection */
        font-weight: bold; /* Make text bold */
        border-left: 4px solid #4299e1; /* Tailwind blue-500, for a distinct indicator */
    }

    /* Book Library Styles */
    .book-cover-item {
        background-color: #2D3748; /* Tailwind gray-800 */
        padding: 0.5rem; /* p-2 */
        border-radius: 0.375rem; /* rounded-md */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        border: 1px solid #4A5568; /* border-gray-600 */
        color: white;
        font-size: 0.875rem; /* text-sm */
        font-weight: 500; /* font-medium */
        text-align: center;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        word-break: break-word; /* Ensure text wraps */
        height: 8rem; /* h-32 Tailwind equiv. */
        /* width-full is implied by grid behavior */
    }

    .book-cover-item:hover {
        background-color: #4A5568; /* Tailwind gray-600 */
        border-color: #718096; /* Tailwind gray-500 */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
    }

    .book-cover-selected {
        background-color: #3182CE; /* Tailwind blue-600 (adjusted from #4299E1 for better match) */
        border-color: #63B3ED; /* Tailwind blue-400 */
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
        /* Using a border to simulate ring effect for simplicity and control */
        border-width: 2px;
        /* ring-2 ring-blue-300 - Tailwind's ring is often an outline/box-shadow.
           A border is simpler here if not using @apply.
           If you want true ring, it's box-shadow: 0 0 0 2px theme('colors.blue.300');
           but this can conflict with existing shadow. For now, thicker border of a highlight color.
        */
        transform: scale(1.05); /* Optional: slight scale */
    }
    /* Ensure selected text remains readable if bg changes significantly */
    .book-cover-selected {
        color: white; /* Ensure text is white on blue background */
    }

    /* For Book Cipher Highlighting */
    .current-morse-target {
        background-color: #f6e05e; /* Tailwind yellow-300 */
        color: #1a202c;           /* Tailwind gray-900 */
        font-weight: bold;
        padding: 0.1em 0.25em;     /* Use em for padding relative to font size */
        border-radius: 3px;
        box-shadow: 0 0 5px #f6e05e; /* Optional: add a subtle glow */
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; /* Smooth transition */
    }

    .morse-char-span {
        /* Add a little padding to each span so highlight doesn't look too cramped */
        padding: 0.05em;
    }

    /* Ensure the full morse display has good contrast and readability */
    #full-book-morse-display {
        font-family: 'Courier New', Courier, monospace; /* Monospaced font for Morse */
        font-size: 1.1rem; /* Slightly larger font for readability */
        line-height: 1.6;  /* Adjust line spacing */
        /* max-height: 400px; /* Already set in HTML, confirm it's good */
        /* overflow-y: auto; /* Already set in HTML */
        /* background-color: #1f2937; /* Slightly different shade if needed, current is gray-700 */
    }

   .deciphered-char {
       color: #a0aec0; /* A light gray color (Tailwind gray-500) */
       font-weight: bold; /* Make it bold to stand out */
   }

    </style>
</head>
<body>
    <nav class="flex justify-center mb-4 space-x-2">
        <button id="learn-practice-nav-btn" data-tab="learn-practice-tab" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 active-tab-button">Learn & Practice</button>
        <button id="book-cipher-nav-btn" data-tab="book-cipher-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Book Cipher</button>
        <button id="morse-pals-nav-btn" data-tab="morse-pals-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Morse Pals</button>
        <button id="global-beacon-nav-btn" data-tab="global-beacon-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Global Beacon</button>
        <button id="settings-nav-btn" data-tab="settings-tab" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Settings</button>
    </nav>
    <h1 class="text-4xl font-bold mb-8 text-center main-title">Morse Code Learner</h1>
    <div id="tab-content-wrapper">
        <div id="learn-practice-tab" class="tab-content">
            <div class="app-container">
                <!-- NEW TOP CONTAINER STARTS HERE -->
                <div class="w-full flex flex-col space-y-4 md:flex-row md:space-x-4 md:items-start mb-6">
                    <!-- Left column for Morse reference -->
                    <div class="w-full md:w-1/2 p-2">
                        <div class="morse-reference">
                            <h2 class="section-title text-2xl font-semibold mb-3 text-center">Morse Code Reference</h2>
                            <div class="overflow-x-auto">
                                <table class="reference-table mx-auto">
                                    <thead>
                                        <tr>
                                            <th>Character</th>
                                            <th>Morse</th>
                                            <th>Character</th>
                                            <th>Morse</th>
                                            <th>Character</th>
                                            <th>Morse</th>
                                            <th>Character</th>
                                            <th>Morse</th>
                                        </tr>
                                    </thead>
                                    <tbody id="morse-reference-body">
                                        <!-- Dynamically populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Right column for Tapper -->
                    <div class="w-full md:w-1/2 p-2">
                        <div id="learnPracticeTapperArea" class="text-center my-4">
                            <!-- The shared visual tapper will be inserted here by JavaScript -->
                             <h2 class="section-title text-2xl font-semibold mb-3 text-center">Practice Tapping Morse</h2>
                        </div>
                    </div>
                </div>
                <!-- NEW TOP CONTAINER ENDS HERE -->

                <!-- Interactive Practice Game Area -->
                <div id="interactivePracticeGame">
                    <p id="practiceText" class="text-3xl font-bold text-yellow-400 min-h-[40px] text-center"></p>
                    <p id="tapperDecodedOutput" class="text-2xl min-h-[30px] break-all text-center bg-gray-700 p-2 rounded mt-2"></p>
                    <p id="practiceMessage" class="text-lg text-center min-h-[24px] mt-2"></p>
                    <button id="newChallengeButton" class="mt-2 w-full bg-green-500 hover:bg-green-700 active:bg-green-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">New Challenge</button>
                    <button id="play-tapped-morse-btn" class="mt-2 w-full bg-purple-500 hover:bg-purple-700 active:bg-purple-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Play My Tapped Morse</button>
                    <button id="clearTapperInputButton" class="mt-2 w-full bg-red-500 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Clear My Tapping</button>
                </div>
                <!-- End Interactive Practice Game Area -->

                <!-- Receive & Type Morse Challenge Area -->
                <div id="receiveTypeChallengeArea" class="mt-8 pt-6 border-t border-gray-600">
                    <h2 class="section-title text-2xl font-semibold mb-3 text-center">Receive & Type Morse Challenge</h2>
                    <div class="flex flex-col items-center space-y-4">
                        <button id="playReceiveChallengeButton" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-700 active:bg-yellow-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">Play Morse Challenge</button>
                        <input type="text" id="receiveChallengeInput" class="w-full md:w-3/4 lg:w-1/2 text-center bg-gray-700 border border-gray-600 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 placeholder-gray-400" placeholder="Type your decoded text here..." disabled>
                        <button id="submitReceiveChallengeButton" class="w-full md:w-auto bg-green-500 hover:bg-green-700 active:bg-green-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>Submit Answer</button>
                        <p id="receiveChallengeFeedback" class="text-lg text-center min-h-[24px] mt-2"></p>
                    </div>
                </div>
                <!-- End Receive & Type Morse Challenge Area -->

                <div class="controls mb-6 text-center">
            <button id="play-morse-btn" class="mr-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Play Morse Code</button>
            <button id="stop-morse-btn" class="mr-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Stop Sound</button>
            <button id="copy-text-btn" class="mr-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Copy Text</button><span id="copy-text-feedback" class="ml-2 text-sm"></span>
            <button id="copy-morse-btn" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Copy Morse</button><span id="copy-morse-feedback" class="ml-2 text-sm"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="text-input" class="block text-sm font-medium mb-2">Enter Text:</label>
                <textarea id="text-input" class="input-output-box w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Type text here..."></textarea>
            </div>
            <div>
                <label for="morse-output" class="block text-sm font-medium mb-2">Morse Code Output:</label>
                <textarea id="morse-output" class="input-output-box w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Or type Morse here (e.g. .... . .-.. .-.. ---)" readonly></textarea>
            </div>
        </div>

        <div class="settings mb-6">
            <h2 class="section-title text-2xl font-semibold mb-3 text-center">Morse Playback Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                <div>
                    <label for="wpm-slider" class="block text-sm font-medium">Text Playback Speed (WPM): <span id="wpm-value">20</span></label>
                    <input type="range" id="wpm-slider" min="5" max="40" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="farnsworth-slider" class="block text-sm font-medium">Text Playback Farnsworth WPM: <span id="farnsworth-value">20</span></label>
                    <input type="range" id="farnsworth-slider" min="5" max="40" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="freq-slider" class="block text-sm font-medium">Playback Tone Frequency (Hz): <span id="freq-value">600</span></label>
                    <input type="range" id="freq-slider" min="300" max="1000" value="600" step="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
             <div class="mt-4 flex justify-center">
                <button id="toggle-theme-btn" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Toggle Dark/Light Mode</button>
            </div>
        </div>

    </div>
        </div>
        <div id="book-cipher-tab" class="tab-content hidden">
            <div class="app-container mx-auto p-6 bg-gray-800 shadow-xl rounded-lg">
                <p id="book-cipher-message" class="text-center feedback-message text-yellow-500 mb-3 h-6"></p> <!-- Message area, h-6 for consistent height -->

                <div id="book-library-view">
                    <!-- Book Library Container -->
                    <div class="mb-4">
                        <label for="book-library-container" class="block mb-2 text-sm font-medium text-gray-300">Select Book:</label>
                        <div id="book-library-container" class="bg-gray-700 border border-gray-600 rounded-lg p-2 max-h-72 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                            <!-- Book covers will be dynamically added here by JavaScript -->
                        </div>
                    </div>
                </div>

                <div id="book-details-view" class="hidden"></div>

                <div id="book-game-view" class="hidden"> <!-- Existing outer container -->
                    <div class="flex flex-col md:flex-row gap-4"> <!-- Main flex container for two columns -->
                        <!-- Left Column: Full Morse Display -->
                        <div id="full-book-morse-display" class="md:w-2/3 p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-300 whitespace-pre-wrap word-wrap-break-word overflow-y-auto" style="max-height: 400px;">
                            Full Morse code will appear here...
                        </div>

                        <!-- Right Column: Tapper, Unlocked Text, Current Target -->
                        <div class="md:w-1/3 flex flex-col gap-4">
                            <div id="bookCipherTapperArea" class="text-center my-4">
                                <!-- The shared visual tapper will be inserted here by JavaScript -->
                            </div>

                            <div>
                                <label for="unlocked-text-display" class="block mb-2 text-sm font-medium text-gray-300">Your Unlocked Text:</label>
                                <div id="unlocked-text-display" class="p-3 min-h-[100px] bg-gray-700 border border-gray-600 rounded-md text-gray-300 whitespace-pre-wrap word-wrap-break-word">-</div>
                            </div>

                            <div class="text-center"> <!-- Centering the current target display -->
                                <label for="current-decoded-char" class="block mb-2 text-sm font-medium text-gray-300">Current Target Morse Letter:</label>
                                <div id="current-decoded-char" class="p-2 bg-gray-700 rounded-md text-2xl font-mono text-center min-w-[60px] inline-block text-gray-300">-</div>
                            </div>

                            <button id="return-to-library-from-game-btn" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 active:bg-gray-800 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-gray-500">Return to Library</button>
                        </div>
                    </div>
                </div> <!-- End of book-game-view -->
            </div>
        </div>
        <div id="morse-pals-tab" class="tab-content hidden">
            <div class="app-container flex flex-col md:flex-row gap-4">
                <!-- Friend List Area (Left Column) -->
                <div class="md:w-1/3 lg:w-1/4 bg-gray-700 p-4 rounded-lg">
                    <input type="text" placeholder="Search Friends..." class="w-full p-2 border border-gray-600 bg-gray-800 text-gray-300 rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button class="w-full p-2 mb-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 focus:ring-blue-500">Add Friend</button>
                    <ul class="space-y-2">
                        <li class="p-2 bg-gray-600 hover:bg-gray-500 rounded-md cursor-pointer text-gray-200">Friend Alpha</li>
                        <li class="p-2 bg-gray-600 hover:bg-gray-500 rounded-md cursor-pointer text-gray-200">Buddy Bravo</li>
                        <li class="p-2 bg-gray-600 hover:bg-gray-500 rounded-md cursor-pointer text-gray-200">Companion Charlie</li>
                    </ul>
                </div>

                <!-- Chat Area (Right Column) -->
                <div class="md:w-2/3 lg:w-3/4 bg-gray-700 p-4 rounded-lg flex flex-col h-[calc(100vh-250px)]">
                    <!-- Messages Display -->
                    <div class="flex-grow overflow-y-auto mb-4 space-y-3">
                        <p class="text-gray-400 text-center">Select a friend to view messages.</p>
                        <!-- Example Received Message -->
                        <div class="flex justify-start">
                            <div class="bg-gray-600 text-white p-3 rounded-lg max-w-xs lg:max-w-md">
                                <p class="text-sm">Friend Alpha: Placeholder message content here, something that might be a bit longer to see how it wraps.</p>
                                <span class="text-xs text-gray-400 block text-right mt-1">10:00 AM</span>
                            </div>
                        </div>
                        <!-- Example Sent Message -->
                        <div class="flex justify-end">
                            <div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs lg:max-w-md">
                                <p class="text-sm">You: This is a placeholder for a message you sent. It's aligned to the right and has a different background.</p>
                                <span class="text-xs text-blue-200 block text-right mt-1">10:01 AM</span>
                            </div>
                        </div>
                    </div>

                    <!-- Message Composition Area -->
                    <div id="morsePalsTapperArea" class="p-4 bg-gray-800 rounded-md my-4 min-h-[180px] flex justify-center items-center">
                        <!-- Shared tapper component will be attached here by JavaScript -->
                        <p class="text-gray-500">Tapper will appear here.</p> 
                    </div>
                    <button class="w-full mt-2 p-3 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 focus:ring-green-500">Send Message</button>
                </div>
            </div>
        </div>
        <div id="global-beacon-tab" class="tab-content hidden">
            <div class="app-container">
                <!-- Optional Header/Info Area -->
                <div class="flex justify-between text-sm text-gray-400 mb-4">
                    <div>Your Callsign: <span id="user-callsign-gb">NOCALL</span></div>
                    <div>Listeners Online: <span id="listeners-online-gb">1 (You)</span></div>
                </div>

                <!-- Public Chat Feed Area -->
                <div id="global-chat-feed" class="chat-feed bg-gray-700 p-4 rounded-md h-64 overflow-y-auto mb-4">
                    <!-- Placeholder Messages -->
                    <div class="message mb-2 p-2 bg-gray-800 rounded-md">
                        <p><span class="font-semibold text-blue-400">USERXYZ:</span> HELLO WORLD</p>
                        <p class="text-gray-500 text-xs">(.... . .-.. .-.. --- / .-- --- .-. .-.. -..)</p>
                        <span class="text-xs text-gray-500 ml-2">10:00 AM</span>
                    </div>
                    <div class="message mb-2 p-2 bg-gray-800 rounded-md">
                        <p><span class="font-semibold text-green-400">CQ_MASTER:</span> CQ CQ CQ DE CQ_MASTER K</p>
                        <p class="text-gray-500 text-xs">(-.-. --.- / -.-. --.- / -.-. --.- / -.. . / -.-. --.- ..__ -- .- ... - . .-. / -.-)</p>
                        <span class="text-xs text-gray-500 ml-2">10:01 AM</span>
                    </div>
                    <div class="message mb-2 p-2 bg-gray-800 rounded-md">
                        <p><span class="font-semibold text-purple-400">BEACON_BOT:</span> WELCOME TO THE GLOBAL BEACON. PLEASE BE RESPECTFUL.</p>
                        <p class="text-gray-500 text-xs">(.-- . .-.. -.-. --- -- . / - --- / - .... . / --. .-.. --- -... .- .-.. / -... . .- -.-. --- -. .-.-.- / .--. .-.. . .- ... . / -... . / .-. . ... .--. . -.-. - ..-. ..- .-.. .-.-.-)</p>
                        <span class="text-xs text-gray-500 ml-2">10:02 AM</span>
                    </div>
                </div>

                <!-- Message Input Area -->
                <div>
                    <div id="globalBeaconTapperArea" class="p-4 bg-gray-800 rounded-md my-4 min-h-[180px] flex justify-center items-center">
                        <p class="text-gray-500">Tapper will appear here.</p>
                    </div>
                    <button id="transmit-global-beacon-btn" class="w-full mt-2 p-3 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 focus:ring-green-500">Broadcast Message</button>
                </div>
            </div>
        </div>
        <div id="settings-tab" class="tab-content hidden">
            <div class="app-container">
                <h2 class="section-title text-2xl font-semibold mb-3 text-center">Tapper Speed Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center justify-items-center p-4">
                    <div class="w-full">
                        <label for="unit-time-input" class="block text-sm font-medium mb-2">Morse Unit Time (ms):</label>
                        <input type="number" id="unit-time-input" value="150" min="50" max="500" step="10" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-white">
                        <span id="unit-time-save-feedback" class="text-sm ml-2 feedback-message"></span>
                    </div>
                    <div class="mt-4 md:mt-0 w-full text-center md:text-left">
                        <p class="text-sm font-medium text-gray-300">Current effective value: <span id="current-unit-time-display" class="font-bold text-white">150</span> ms</p>
                    </div>
                </div>

                <!-- New Sound Settings Section -->
                <h2 class="section-title text-2xl font-semibold mt-6 mb-3 text-center">Sound Settings</h2>
                <div class="flex items-center justify-center p-4">
                    <label for="master-sound-toggle" class="mr-4 text-sm font-medium text-gray-300">Master Sound</label>
                    <div class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="master-sound-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        <span id="master-sound-status-text" class="ml-3 text-sm font-medium text-gray-300">On</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hiddenTapperStorage" style="display: none;"></div>
    <div id="sharedVisualTapperWrapper" style="display: none;">
        <div class="tapper-section-container text-center my-4">
            <div class="tapper-area inline-block mr-2">
                <div class="tapper-container">
                    <div id="tapper" class="tapper shadow-lg mx-auto">Tap!</div>
                </div>
            </div>
            <button id="spaceButton" title="End Letter" class="align-middle text-sm bg-blue-500 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2 px-3 rounded-full h-14 w-14 flex items-center justify-center transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">End<br>Ltr</button>
            <div class="output-area mt-2">
                <h3 class="text-lg font-semibold mb-1">Your Morse:</h3>
                <p id="tapperMorseOutput" class="text-xl font-mono min-h-[25px] break-all bg-gray-700 p-2 rounded"></p>
            </div>
        </div>
    </div>
    
    <script>
        // Morse code dictionary
        const morseCode = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 'G': '--.', 'H': '....',
            'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---', 'P': '.--.',
            'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..',
            '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...',
            '8': '---..', '9': '----.', '0': '-----',
            '.': '.-.-.-', ',': '--..--', '?': '..--..', "'": '.----.', '!': '-.-.--', '/': '-..-.',
            '(': '-.--.', ')': '-.--.-', '&': '.-...', ':': '---...', ';': '-.-.-.', '=': '-...-',
            '+': '.-.-.', '-': '-....-', '_': '..--.-', '"': '.-..-.', '$': '...-..-', '@': '.--.-.-',
            ' ': '/' // Represent space between words with a slash or longer pause
        };

        const reversedMorseCode = {};
        for (const key in morseCode) {
            reversedMorseCode[morseCode[key]] = key;
        }

        // AudioContext for playing Morse code sound
        let audioContext;
        let oscillator;
        let gainNode;
        let isPlaying = false;
        let stopMorseCode = false; // Flag to stop ongoing Morse playback

        // DOM Elements
        const textInput = document.getElementById('text-input');
        const morseOutput = document.getElementById('morse-output');
        const playMorseBtn = document.getElementById('play-morse-btn');
        const stopMorseBtn = document.getElementById('stop-morse-btn');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const copyMorseBtn = document.getElementById('copy-morse-btn');
        const wpmSlider = document.getElementById('wpm-slider');
        const wpmValue = document.getElementById('wpm-value');
        const farnsworthSlider = document.getElementById('farnsworth-slider');
        const farnsworthValue = document.getElementById('farnsworth-value');
        const freqSlider = document.getElementById('freq-slider');
        const freqValue = document.getElementById('freq-value');
        const morseReferenceBody = document.getElementById('morse-reference-body');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');


        // Initialize AudioContext
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
            }
        }

        // Settings
        let wpm = parseInt(wpmSlider.value);
        let farnsworthWpm = parseInt(farnsworthSlider.value); // Farnsworth WPM
        let frequency = parseInt(freqSlider.value);

        function getPlaybackFrequency() {
          return frequency;
        }

        // Timing (PARIS standard)
        // Dot is 1 unit
        // Dash is 3 units
        // Intra-character space is 1 unit
        // Inter-character space is 3 units
        // Word space is 7 units

        // WPM calculation: A standard word "PARIS" has 50 units.
        // If WPM is X, then X words take 60 seconds.
        // X * 50 units = 60 seconds
        // 1 unit = 60 / (X * 50) = 1.2 / X seconds
        let dotDuration = 1.2 / wpm; // seconds

        function updateDurations() {
            dotDuration = 1.2 / wpm;
            if (farnsworthWpm < wpm && farnsworthWpm > 0) {
                // Adjust inter-character and word spaces for Farnsworth timing
                // Character speed remains at 'wpm', but spacing is as if overall WPM is 'farnsworthWpm'
                // This means the 'unit' for spacing is based on farnsworthWpm
                // However, dot/dash/intra-character space are based on 'wpm'
                // This is a common interpretation. Some systems might vary.
            }
             // Ensure Farnsworth is not faster than character speed
            if (farnsworthSlider.value > wpmSlider.value) {
                farnsworthSlider.value = wpmSlider.value;
                farnsworthValue.textContent = wpmSlider.value;
                farnsworthWpm = wpm;
            }
        }
        updateDurations(); // Initial calculation

        // --- Event Listeners ---
        textInput.addEventListener('input', () => {
            const text = textInput.value.toUpperCase();
            morseOutput.value = textToMorse(text);
        });

        playMorseBtn.addEventListener('click', async () => {
            if (isPlaying) return;
            initAudio(); // Ensure AudioContext is ready (especially on user gesture)
            const morse = morseOutput.value;
            if (morse) {
                // stopMorseBtn.disabled = false; // Enabled inside playMorseSequence
                await playMorseSequence(morse);
            }
        });

        stopMorseBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopMorseCode = true; // Set flag to stop the sequence
                stopMorseBtn.disabled = true; // Disable stop button as it's now clicked
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect(); // Clean up
                    oscillator = null;
                }
                if (gainNode) { // Ensure gainNode is controlled
                    gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                }
                isPlaying = false;
                playMorseBtn.disabled = false;
                console.log("Morse playback stopped by user.");
            }
        });


        copyTextBtn.addEventListener('click', () => {
            const feedbackEl = document.getElementById('copy-text-feedback');
            navigator.clipboard.writeText(textInput.value)
                .then(() => {
                    feedbackEl.textContent = 'Copied!';
                    feedbackEl.className = 'ml-2 text-sm feedback-message text-green-500';
                    setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
                })
                .catch(err => {
                    feedbackEl.textContent = 'Error!';
                    feedbackEl.className = 'ml-2 text-sm feedback-message text-red-500';
                    console.error('Error copying text: ', err);
                    setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
                });
        });

        copyMorseBtn.addEventListener('click', () => {
            const feedbackEl = document.getElementById('copy-morse-feedback');
            navigator.clipboard.writeText(morseOutput.value)
                .then(() => {
                    feedbackEl.textContent = 'Copied!';
                    feedbackEl.className = 'ml-2 text-sm feedback-message text-green-500';
                    setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
                })
                .catch(err => {
                    feedbackEl.textContent = 'Error!';
                    feedbackEl.className = 'ml-2 text-sm feedback-message text-red-500';
                    console.error('Error copying Morse code: ', err);
                    setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
                });
        });

        wpmSlider.addEventListener('input', (e) => {
            wpm = parseInt(e.target.value);
            wpmValue.textContent = wpm;
            // If new WPM is lower than current Farnsworth, pull Farnsworth down.
            // Farnsworth cannot be higher than character WPM.
            if (wpm < farnsworthWpm) {
                farnsworthWpm = wpm;
                farnsworthSlider.value = wpm;
                farnsworthValue.textContent = wpm;
            }
            updateDurations();
        });

        farnsworthSlider.addEventListener('input', (e) => {
            farnsworthWpm = parseInt(e.target.value);
            // Farnsworth WPM cannot be higher than character WPM.
            // If user tries to set Farnsworth higher, cap it at current WPM.
            // Do NOT increase WPM based on Farnsworth changes.
            if (farnsworthWpm > wpm) {
                farnsworthWpm = wpm;
                e.target.value = wpm; // Correct the slider position
            }
            farnsworthValue.textContent = farnsworthWpm;
            updateDurations();
        });


        freqSlider.addEventListener('input', (e) => {
            frequency = parseInt(e.target.value);
            freqValue.textContent = frequency;
        });

        toggleThemeBtn.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            document.querySelector('.app-container').classList.toggle('light-theme-container');

            // Persist theme preference
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.setItem('theme', 'dark');
            }
        });


        // --- Core Functions ---

// --- Tab Navigation ---
const navTabButtons = document.querySelectorAll('nav button[data-tab]');
const tabContentDivs = document.querySelectorAll('.tab-content');
const sharedVisualTapperWrapper = document.getElementById('sharedVisualTapperWrapper');
const hiddenTapperStorage = document.getElementById('hiddenTapperStorage');

function attachTapperToArea(targetAreaId) {
    console.log("[attachTapperToArea] Received targetAreaId:", targetAreaId); // New log

    const targetElement = document.getElementById(targetAreaId);
    console.log("[attachTapperToArea] Found targetElement:", targetElement); // New log

    if (sharedVisualTapperWrapper && targetElement) {
        console.log("[attachTapperToArea] sharedVisualTapperWrapper.style.display (before):", sharedVisualTapperWrapper.style.display); // New log
        console.log("[attachTapperToArea] sharedVisualTapperWrapper.parentNode (before):", sharedVisualTapperWrapper.parentNode); // New log

        targetElement.appendChild(sharedVisualTapperWrapper);
        sharedVisualTapperWrapper.style.display = 'block'; // Or 'flex' if its internal layout needs it

        console.log("[attachTapperToArea] sharedVisualTapperWrapper.style.display (after):", sharedVisualTapperWrapper.style.display); // New log
        console.log("[attachTapperToArea] sharedVisualTapperWrapper.parentNode (after):", sharedVisualTapperWrapper.parentNode); // New log
        console.log(`[attachTapperToArea] Tapper attached to ${targetAreaId}`); // Existing log, ensure it's still there
    } else {
        console.error(`[attachTapperToArea] Failed to attach tapper: sharedVisualTapperWrapper (${sharedVisualTapperWrapper ? 'exists' : 'null/undefined'}) or targetElement (${targetElement ? 'exists' : 'null/undefined'} for ID ${targetAreaId}) not found.`); // Enhanced log
    }
}

function detachSharedTapper() {
    // Call resetVisualTapperState if it's available
    if (typeof resetVisualTapperState === 'function') {
        resetVisualTapperState();
    } else {
        console.warn("detachSharedTapper: resetVisualTapperState function not found. Tapper state may not be fully reset.");
    }

    if (sharedVisualTapperWrapper && hiddenTapperStorage) {
        // Ensure the tapper is moved to hidden storage if it's not already there.
        if (sharedVisualTapperWrapper.parentNode !== hiddenTapperStorage) {
            hiddenTapperStorage.appendChild(sharedVisualTapperWrapper);
        }
        // Always hide it when detaching.
        sharedVisualTapperWrapper.style.display = 'none';
        console.log("Tapper detached and hidden. State reset attempted.");
    } else {
         console.error(`Failed to detach tapper: sharedVisualTapperWrapper (${sharedVisualTapperWrapper}) or hiddenTapperStorage (${hiddenTapperStorage}) not found. State reset was attempted if function was available.`);
    }
}


function showTab(tabIdToShow) {
    // Detach tapper from any previous tab BEFORE hiding all tabs
    detachSharedTapper();

    tabContentDivs.forEach(div => {
        div.classList.add('hidden');
    });

    navTabButtons.forEach(button => {
        button.classList.remove('active-tab-button');
        button.classList.add('bg-gray-700', 'text-gray-300');
        button.classList.remove('bg-blue-600', 'text-white');
    });

    const selectedTabContent = document.getElementById(tabIdToShow);
    if (selectedTabContent) {
        selectedTabContent.classList.remove('hidden');
    }

    const selectedNavButton = document.querySelector(`nav button[data-tab='${tabIdToShow}']`);
    if (selectedNavButton) {
        selectedNavButton.classList.add('active-tab-button');
        selectedNavButton.classList.remove('bg-gray-700', 'text-gray-300');
        selectedNavButton.classList.add('bg-blue-600', 'text-white');
    }

    // If switching to the Learn & Practice tab, start a new challenge.
    if (tabIdToShow === 'learn-practice-tab' && typeof startNewChallenge === 'function') {
        startNewChallenge();
    }

    // Attach tapper to the new tab if it's the book cipher tab or learn & practice tab
    if (tabIdToShow === 'book-cipher-tab') {
        attachTapperToArea('bookCipherTapperArea');
    } else if (tabIdToShow === 'learn-practice-tab') {
        attachTapperToArea('learnPracticeTapperArea');
    } else if (tabIdToShow === 'morse-pals-tab') {
        attachTapperToArea('morsePalsTapperArea');
    } else if (tabIdToShow === 'global-beacon-tab') {
        attachTapperToArea('globalBeaconTapperArea');
    }
    // No 'else' here, so if it's another tab, tapper remains detached (which is correct)
}

navTabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        showTab(tabId);
    });
});

document.addEventListener('DOMContentLoaded', () => {
    // Set the initial active tab correctly.
    // The learn-practice-nav-btn might already have active-tab-button from HTML.
    // This call ensures consistent state management via JS.
    showTab('learn-practice-tab'); // Initial tab
    // Explicit detach on DOMContentLoaded after initial showTab is good practice,
    // though current showTab logic handles it.
    // If learn-practice-tab is not supposed to have tapper, this ensures it's gone.
    // If learn-practice-tab *was* supposed to have it, showTab would call attach.
    // Given showTab now detaches first, this specific call here might be redundant
    // unless the very first tab shown *shouldn't* have the tapper.
    // Let's assume 'learn-practice-tab' does not use the tapper initially.
    // The `showTab` function already calls `detachSharedTapper`, so this is not strictly needed here.
    // detachSharedTapper(); 
});
// --- End Tab Navigation ---

        function textToMorse(text) {
            return text.split('').map(char => {
                if (morseCode[char]) {
                    return morseCode[char];
                } else if (char === ' ') {
                    return '/'; // Word separator
                }
                return ''; // Or some indicator for unknown characters
            }).join(' '); // Space between Morse codes of letters
        }

        function morseToText(morse) {
            return morse.split(' ').map(code => {
                if (code === '/') return ' '; // Word separator
                return reversedMorseCode[code] || ''; // Or indicator for unknown code
            }).join('');
        }

       async function playTone(duration, toneFrequency) {
            // Check master sound setting FIRST
            if (typeof window.isMasterSoundEnabled !== 'undefined' && !window.isMasterSoundEnabled) {
                // console.log('Master sound is OFF, playTone will not play.'); // Debug log
                return Promise.resolve(); // Exit if master sound is disabled
            }

            if (stopMorseCode || !audioContext) {
                // console.warn("playTone: stopMorseCode active or no audioContext. Aborting tone."); // Optional log
                return Promise.resolve(); // Correctly return a resolved promise
            }

            return new Promise(resolve => {
                if (!audioContext || audioContext.state === 'suspended') {
                    console.warn("AudioContext not active. Cannot play tone.");
                    resolve();
                    return;
                }

                oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                // Use the provided toneFrequency, falling back to getPlaybackFrequency if necessary
                const resolvedFrequency = typeof toneFrequency === 'number' ? toneFrequency : getPlaybackFrequency();
                oscillator.frequency.setValueAtTime(resolvedFrequency, audioContext.currentTime);

                // Ramp up volume smoothly
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01); // Quick ramp up

                oscillator.connect(gainNode);
                oscillator.start(audioContext.currentTime);

                // Schedule stop and ramp down
                oscillator.stop(audioContext.currentTime + duration);
                // Ramp down volume smoothly before stopping
                gainNode.gain.setValueAtTime(1, audioContext.currentTime + duration - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);


                oscillator.onended = () => {
                    if (oscillator && oscillator.connected) { // Check if it's the current oscillator
                         oscillator.disconnect();
                    }
                    resolve();
                };
            });
        }


        async function playMorseSequence(morse, customDotDur, customFreq) {
            if (isPlaying) return;
            isPlaying = true;
            stopMorseCode = false; // Reset stop flag
            playMorseBtn.disabled = true;
            if(stopMorseBtn) stopMorseBtn.disabled = false; // Enable stop button

            const currentPlaybackFrequency = typeof customFreq === 'number' ? customFreq : getPlaybackFrequency(); // MODIFIED

            let effectiveDotDuration;
            let effectiveInterCharSpace;
            let effectiveWordSpace;
            let effectiveIntraCharSilence;

            if (typeof customDotDur === 'number') {
                effectiveDotDuration = customDotDur;
                effectiveIntraCharSilence = effectiveDotDuration; // 1 unit silence after each signal
                effectiveInterCharSpace = 3 * effectiveDotDuration; // 3 units for inter-character
                effectiveWordSpace = 7 * effectiveDotDuration;    // 7 units for word space
            } else {
                // Use existing WPM/Farnsworth logic
                effectiveDotDuration = dotDuration; // Global dotDuration based on WPM
                effectiveIntraCharSilence = dotDuration; // Base silence is 1 WPM-based unit

                let spaceUnit = 1.2 / (farnsworthWpm > 0 && farnsworthWpm < wpm ? farnsworthWpm : wpm);
                effectiveInterCharSpace = 3 * spaceUnit;
                effectiveWordSpace = 7 * spaceUnit;
            }

            const signals = morse.split('');
            for (let i = 0; i < signals.length; i++) {
                if (stopMorseCode) {
                    console.log("Stopping Morse sequence playback.");
                    break;
                }

                const signal = signals[i];
                let signalDuration = 0;
                // Default silence after a signal is the intra-character silence unit
                let silenceDurationAfterSignal = effectiveIntraCharSilence;

                if (signal === '.') {
                    signalDuration = effectiveDotDuration;
                } else if (signal === '-') {
                    signalDuration = 3 * effectiveDotDuration;
                } else if (signal === ' ') { // Space between letters in the same word
                    // This signal itself is silence. The silence *after* this "signal" is what we calculate.
                    // The total silence for an inter-character space is `effectiveInterCharSpace`.
                    // Since `silenceDurationAfterSignal` (1 unit) is already added by default,
                    // we adjust the duration of this "space signal" to make up the difference.
                    signalDuration = 0; // No tone for space
                    // Total silence needed is effectiveInterCharSpace.
                    // The loop adds effectiveIntraCharSilence by default.
                    // So, the "duration" of this space signal should be effectiveInterCharSpace - effectiveIntraCharSilence
                    silenceDurationAfterSignal = effectiveInterCharSpace - effectiveIntraCharSilence;
                     if (silenceDurationAfterSignal < 0) silenceDurationAfterSignal = 0; // Should not happen with correct logic
                } else if (signal === '/') { // Space between words
                    signalDuration = 0; // No tone for space
                    // Total silence needed is effectiveWordSpace.
                    silenceDurationAfterSignal = effectiveWordSpace - effectiveIntraCharSilence;
                    if (silenceDurationAfterSignal < 0) silenceDurationAfterSignal = 0;
                }

                if (signalDuration > 0) {
                    await playTone(signalDuration, currentPlaybackFrequency);
                }

                // After the tone (or if it was a space character that has 0 signal duration), wait for its specific silence duration
                if (silenceDurationAfterSignal > 0 && !stopMorseCode) {
                    await new Promise(resolve => setTimeout(resolve, silenceDurationAfterSignal * 1000));
                }
            }
            isPlaying = false;
            playMorseBtn.disabled = false;
            if(stopMorseBtn) stopMorseBtn.disabled = true; // Disable stop button
            // Consider if the custom play button also needs its state managed (e.g., playTappedMorseBtn.disabled = false;)
            if (stopMorseCode) {
                console.log("Morse sequence officially ended due to stop request.");
            }
        }


        // --- UI Initialization ---
        function populateMorseReference() {
    const characters = Object.keys(morseCode);
    let rowContent = '';
    for (let i = 0; i < characters.length; i++) {
        if (i % 4 === 0) { // Start new row
            if (i > 0) rowContent += '</tr>';
            rowContent += '<tr>';
        }
        const char = characters[i];
        const displayChar = char === ' ' ? 'Space' : char;

        let idChar = char; // Default to using the char itself for ID
        // Mapping for characters that are problematic in IDs or need a specific name
        if (char === '.') idChar = 'Period';
        else if (char === ',') idChar = 'Comma';
        else if (char === '?') idChar = 'QuestionMark';
        else if (char === "'") idChar = 'Apostrophe';
        else if (char === '!') idChar = 'ExclamationMark';
        else if (char === '/') idChar = 'Slash';
        else if (char === '(') idChar = 'ParenthesisOpen';
        else if (char === ')') idChar = 'ParenthesisClose';
        else if (char === '&') idChar = 'Ampersand';
        else if (char === ':') idChar = 'Colon';
        else if (char === ';') idChar = 'Semicolon';
        else if (char === '=') idChar = 'Equals';
        else if (char === '+') idChar = 'Plus';
        else if (char === '-') idChar = 'Hyphen';
        else if (char === '_') idChar = 'Underscore';
        else if (char === '"') idChar = 'Quote';
        else if (char === '$') idChar = 'Dollar';
        else if (char === '@') idChar = 'AtSign';
        else if (char === ' ') idChar = 'Space';
        // Alphanumeric characters (A-Z, 0-9) will use their own value for idChar.

        rowContent += `<td id="ref-char-${idChar}">${displayChar}</td><td id="ref-morse-${idChar}">${morseCode[char]}</td>`;

        if (i === characters.length - 1) { // Ensure last row is closed correctly
            let cellsInLastRow = (i % 4) + 1; // Number of items processed for the current row
            if (cellsInLastRow < 4) {
                for (let j = cellsInLastRow; j < 4; j++) {
                    rowContent += '<td></td><td></td>'; // Add empty pairs for missing items
                }
            }
            rowContent += '</tr>'; // Close the last row
        }
    }
    morseReferenceBody.innerHTML = rowContent;
}


        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                document.querySelector('.app-container').classList.add('light-theme-container');
            } else {
                // Dark theme is default, so no need to remove classes if they aren't there
                // but if they are (e.g. from a previous session), ensure they are removed.
                document.body.classList.remove('light-theme');
                document.querySelector('.app-container').classList.remove('light-theme-container');
            }
        }


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateMorseReference();
            applySavedTheme(); // Apply theme on load
            updateDurations(); // Initialize durations based on default slider values

            // Set initial values for sliders display
            wpmValue.textContent = wpmSlider.value;
            farnsworthValue.textContent = farnsworthSlider.value;
            freqValue.textContent = freqSlider.value;

            // Event listener for "Play My Tapped Morse" button
            const playTappedMorseBtn = document.getElementById('play-tapped-morse-btn');
            const tapperDecodedOutputEl = document.getElementById('tapperDecodedOutput');

            if (playTappedMorseBtn && tapperDecodedOutputEl) {
                playTappedMorseBtn.addEventListener('click', async () => {
                    if (isPlaying) {
                        console.log("Audio is currently playing. Please wait.");
                        return;
                    }
                    initAudio(); // Ensure AudioContext is ready

                    const textToPlay = tapperDecodedOutputEl.textContent;
                    if (!textToPlay || textToPlay.trim() === '') {
                        console.log("No tapped text to play.");
                        // Optionally, provide user feedback e.g., alert("No tapped text to play.");
                        return;
                    }

                    const morseToPlay = textToMorse(textToPlay.toUpperCase());
                    if (!morseToPlay || morseToPlay.trim() === '') {
                        console.log("Could not convert tapped text to Morse.");
                        // Optionally, provide user feedback
                        return;
                    }

                    // Assuming UNIT_TIME_MS is globally available or getVisualTapperUnitTime() exists
                    let currentUnitTimeMs = 150; // Default if not found
                    if (typeof getVisualTapperUnitTime === 'function') {
                        currentUnitTimeMs = getVisualTapperUnitTime();
                    } else if (typeof UNIT_TIME_MS !== 'undefined') { // Fallback to global if getter undefined
                        currentUnitTimeMs = UNIT_TIME_MS;
                        console.warn("Using global UNIT_TIME_MS as getVisualTapperUnitTime() is not defined.");
                    } else if (typeof window.UNIT_TIME_MS !== 'undefined') { // Further fallback
                        currentUnitTimeMs = window.UNIT_TIME_MS;
                        console.warn("Using window.UNIT_TIME_MS as getVisualTapperUnitTime() is not defined.");
                    } else {
                        console.warn("Global UNIT_TIME_MS and getVisualTapperUnitTime() not found, using default 150ms for playback.");
                    }

                    const customDotDuration = currentUnitTimeMs / 1000.0; // Convert ms to seconds
                    
                    await playMorseSequence(morseToPlay, customDotDuration, getPlaybackFrequency()); // MODIFIED to use getter
                });
            } else {
                console.error("Could not find 'play-tapped-morse-btn' or 'tapperDecodedOutput' elements.");
            }
        });

        // VISUAL TAPPER JS HAS BEEN MOVED FROM HERE
    </script>
    <script src="js/learnPracticeGame.js" defer></script>
    <script src="js/visualTapper.js" defer></script>
    <script src="js/settings.js" defer></script> 
    <script src="js/bookCipher.js" defer></script> 
    <script src="js/morsePals.js" defer></script>

    <!-- Unlocked Text Modal -->
    <div id="unlocked-text-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <h3 id="unlocked-text-modal-title" class="text-xl font-semibold text-white mb-4">Unlocked Book Text</h3>
            <div id="unlocked-text-modal-content" class="overflow-y-auto flex-grow text-gray-300 bg-gray-700 p-3 rounded">
                <!-- Full text will be loaded here -->
            </div>
            <button id="close-unlocked-text-modal-btn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md self-center">Close</button>
        </div>
    </div>
</body>
</html>
